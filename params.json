{"name":"Bifrozt-ansible","tagline":"Deploy Bifrozt using Ansible","body":"---\r\n\r\nThis document will provide an overview of how the Bifrozt deployment should look like and how it will work once it's complete, define the requirements for this deployment, explain the two different ways to deploy Bifrozt and provide a step by step instruction of the most common method.\r\n\r\n---\r\n\r\n#### Overview.\r\n\r\nGenerally speaking, Bifrozt is a NAT device with a DHCP server that is usually deployed with one NIC (eth0) connected directly to the Internet and one NIC (eth1) connected to the internal network.<br>\r\n\r\n![Example deployment](https://www.honeynet.org/sites/default/files/images/deploy_example.png)\r\n\r\nWhat differentiates Bifrozt from other standard NAT devices is its ability to work as a transparent SSHv2 proxy between an attacker and your honeypot. The software that's being used as a SSHv2 proxy is called [HonSSH](https://github.com/tnich/honssh) and has been developed by Thomas Nicholson.\r\n<br><br>\r\nIf you deployed a SSH server on Bifrozt's internal network it would log all the interaction to a TTY file in plain text that could be viewed later and capture a copy of any files that were downloaded. You do not have to install any additional software, compile any kernel modules or use a specific version or type of operating system on the internal SSH server for this to work\r\n<br><br>\r\nTo prevent the attackers from using the honeypot to attack other systems it will limit outbound traffic to a set number of ports, number of connections and the amount of packets being sent, if the firewall finds that any of these limits are exceeded it will start to drop the connections and/or packets sent.\r\n\r\n---\r\n\r\n#### Requirements.\r\n\r\n##### Hardware.\r\n\r\nMinimum hardware requirements (recommended within parenthesis).\r\n\r\nBifrozt\r\n- 2x network interface cards\r\n- 1 GB RAM (2 GB or more recommended)\r\n- 10 GB Hard drive (20 GB or more recommended)\r\n- 1 CPU (2 or more recommended)\r\n\r\nHoneypot\r\n- The hardware requirements should reflect the type of server thats being offered.\r\n\r\n##### Software\r\n\r\nBifrozt\r\n- Running Ubuntu 14.04 or later (server version recommended but, works with Desktop version as well).\r\n- OpenSSH server (will be added automatically if using local installation method)\r\n\r\nHoneypot\r\n- OpenSSH server\r\n\r\n---\r\n\r\n#### Installation options.\r\n\r\nThere are mainly two ways of installing the components that turns a system into a honeypot router (aka. Bifrozt)\r\n- **Install locally using Ansible.**<br>  If you only plan in using a single instance of Bifrozt (which is the most common way of doing it) you should install it locally.\r\n- **Install from a Ansible control machine.**<br>  If you have a large infrastructure, plan on deploying Bifrozt to multiple nodes or already have a Ansible control machine installed its only natural to deploy Bifrozt from that.\r\n\r\nIf you already are using Ansible and have a control machine I assume that you are able to deploy without any further instructions. \r\n<br>\r\n\r\n##### Install locally using Ansible.\r\n\r\nThis is the most common way of deploying Bifrozt but, can also be a bit tricky if you never used Ansible before, so i've created a bash script that does most of the tasks for you.<br>\r\nEven tho i've created this script i'd like you to be aware of what this script is doing, this will help you troubleshoot any potential issues with it and give a better understanding of the process.\r\n<br><br>\r\nWhen executed it will preform three checks that **must** be passed\r\n- The executing user is *root*.\r\n- The operating system is *Ubuntu*.\r\n- The system has two network interface cards (not counting local interface) and both starts with *eth*.\r\n\r\nIf all three check are passed you should see something like this\r\n```\r\n2016-03-09 18:16:30 - Are we root?...Yes\r\n2016-03-09 18:16:30 - Is this operating system Ubuntu?...Yes\r\n2016-03-09 18:16:30 - Do we have two network interface cards?...Yes\r\n```\r\nThe script will then execute the listed tasks in sequential order\r\n- Install all available updates\r\n- Add the PPA for Ansible\r\n- Install ansible, git and OpenSSH server (if not installed already)\r\n- Grab the latest version of [bifrozt-ansible](https://github.com/Bifrozt/bifrozt-ansible)\r\n- Generate SSH keys that will be used by Ansible\r\n- Run the Ansible playbook that configures as Bifrozt. This playbook will also remove the Ansible software and the generated SSH keys. If this playbook completes without any issues, it will reboot the machine and the installation is complete.\r\n\r\nTo run the playbook locally on the machine you would like to use as Bifrozt, execute the following commands<br>\r\n`wget https://raw.githubusercontent.com/Bifrozt/bifrozt-ansible/master/bifrozt_setup.sh`<br>\r\n\r\nThis will download the `bifrozt_setup.sh`, to run it you have to find the MAC address of your honeypot. The MAC address must be given as an argument to the script as shown in the example below.\r\n\r\n`sudo bash bifrozt_setup.sh 00:11:22:33:44:55`<br>\r\n<br>\r\n\r\nWhen the script completes you should see the following lines:<br>\r\n```\r\n2016-03-09 18:21:36 - The SSH server is now running on TCP port: 53725\r\n2016-03-09 18:21:36 - Applying new firewall rules...\r\n2016-03-09 18:21:36 - The firewall is now accepting SSH connections on TCP port: 53725\r\n2016-03-09 18:21:36 - bifrozt_setup.sh has completed its execution. Do the following:\r\n2016-03-09 18:21:36 - Note what port SSH is running on.\r\n2016-03-09 18:21:36 - If the honeypot is running, shut it off.\r\n2016-03-09 18:21:36 - Reboot Bifrozt (this machine).\r\n2016-03-09 18:21:36 - Start the honeypot machine once Bifrozt is rebooted.\r\n2016-03-09 18:21:36 - Start HonSSH with: sudo honsshctrl start.\r\n```\r\n\r\n- Its important that you take note of which port the SSH server will be running on,`53725` in this example, as its randomly generated during the setup.<br>\r\n- If the honeypot is running, power it off.\r\n- Reboot the Bifrozt machine.\r\n- When the Bifrozt machine has rebooted, start the honeypot.\r\n- When the honeypot is running, start HonSSH: `sudo honsshctrl start`. The `honsshctrl` script will start HonSSH in the background and start to tail the application log (`/opt/honssh/logs/honssh.log`), you can stop tailing the log using CTRL+C without stopping HonSSH.\r\n\r\n---\r\n\r\nExample of what the `bifrozt_setup.sh` script will look like.<br>\r\n\r\n```\r\n========= bifrozt_setup.sh - 0.0.5 - 2016, Feb 24 - Are Hansen =========\r\n\r\n2016-03-09 18:16:30 - Are we root?...Yes\r\n2016-03-09 18:16:30 - Is this operating system Ubuntu?...Yes\r\n2016-03-09 18:16:30 - Do we have two network interface cards?...Yes\r\n2016-03-09 18:16:30 - Installing all avalible system updates...\r\n2016-03-09 18:18:42 - Installing some minor dependencies...\r\n2016-03-09 18:18:42 - Adding Ansible PPA... \r\n2016-03-09 18:18:43 - Installing Ansible... \r\n2016-03-09 18:19:05 - Grabbing a clone of https://github.com/Bifrozt/bifrozt-ansible.git...\r\n2016-03-09 18:19:06 - Generating Ansible SSH keys...\r\n2016-03-09 18:19:07 - Setting up authentication key for root user (will be removed later)...\r\n2016-03-09 18:19:07 - Executing the playbook now...\r\n\r\nPLAY [Converting system into a honeypot router] ********************************\r\n\r\nTASK [setup] *******************************************************************\r\nok: [192.168.90.41]\r\n\r\nTASK [software : Running apt-get update] ***************************************\r\nok: [192.168.90.41]\r\n\r\nTASK [software : Running apt-get upgrade] **************************************\r\nchanged: [192.168.90.41]\r\n\r\nTASK [software : Installing dependecies from official apt repo] ****************\r\nchanged: [192.168.90.41] => (item=[u'athena-jot', u'git', u'htop', u'isc-dhcp-server', u'ngrep', u'python-geoip', u'python-mysqldb', u'python-pip', u'python-twisted', u'tcpdump', u'tcpflow', u'tmux', u'vim', u'wget', u'whois'])\r\n\r\nTASK [software : Installing dependencies from pip] *****************************\r\nchanged: [192.168.90.41] => (item=geoip2)\r\nok: [192.168.90.41] => (item=requests)\r\n\r\nTASK [system : Creating logrotation for /var/log/firewall.log] *****************\r\nchanged: [192.168.90.41]\r\n\r\nTASK [system : Setting permissions on /etc/logrotate.d/iptables] ***************\r\nok: [192.168.90.41]\r\n\r\nTASK [system : Costumizing sysctl.conf] ****************************************\r\nchanged: [192.168.90.41]\r\n\r\nTASK [system : Setting permissions on /etc/sysctl.conf] ************************\r\nchanged: [192.168.90.41]\r\n\r\nTASK [system : Creating rsyslog for iptables] **********************************\r\nchanged: [192.168.90.41]\r\n\r\nTASK [system : Setting permissions on /etc/rsyslog.d/13-iptables] **************\r\nok: [192.168.90.41]\r\n\r\nTASK [system : Setting custom interval for rotating firewall.log] **************\r\nchanged: [192.168.90.41]\r\n\r\nTASK [system : Setting correct permissions on /var/log/firewall.log] ***********\r\nchanged: [192.168.90.41]\r\n\r\nTASK [system : Setting permissions on /var/spool/cron/crontabs/root] ***********\r\nchanged: [192.168.90.41]\r\n\r\nTASK [system : Preparing HonSSH to start at boot] ******************************\r\nchanged: [192.168.90.41]\r\n\r\nTASK [system : Setting permissions on /etc/rc.local] ***************************\r\nok: [192.168.90.41]\r\n\r\nTASK [network : Configuring sshd to run on tcp/60777] **************************\r\nchanged: [192.168.90.41]\r\n\r\nTASK [network : Setting permissions on /etc/ssh/sshd_config] *******************\r\nok: [192.168.90.41]\r\n\r\nTASK [network : Setting up isc-dhcp-server configuration] **********************\r\nchanged: [192.168.90.41]\r\n\r\nTASK [network : Setting permissions on /etc/dhcp/dhcpd.conf] *******************\r\nok: [192.168.90.41]\r\n\r\nTASK [network : Configuring isc-dhcp-server to run on eth1] ********************\r\nchanged: [192.168.90.41]\r\n\r\nTASK [network : Setting permissions on /etc/default/isc-dhcp-server] ***********\r\nok: [192.168.90.41]\r\n\r\nTASK [network : Configuring network interfaces] ********************************\r\nchanged: [192.168.90.41]\r\n\r\nTASK [network : Setting permissions on /etc/network/interfaces] ****************\r\nok: [192.168.90.41]\r\n\r\nTASK [network : Setting up iptables for IPv4] **********************************\r\nchanged: [192.168.90.41]\r\n\r\nTASK [network : Setting permissions on /etc/network/ipv4hater] *****************\r\nok: [192.168.90.41]\r\n\r\nTASK [network : Setting up iptables for IPv6] **********************************\r\nchanged: [192.168.90.41]\r\n\r\nTASK [network : Setting permissions on /etc/network/ipv6hater] *****************\r\nok: [192.168.90.41]\r\n\r\nTASK [honssh : Cloning the latest version of HonSSH] ***************************\r\nchanged: [192.168.90.41]\r\n\r\nTASK [honssh : Removing default honsshctrl.sh] *********************************\r\nchanged: [192.168.90.41]\r\n\r\nTASK [tools : Preparing to install custom Python modules] **********************\r\nchanged: [192.168.90.41]\r\n\r\nTASK [tools : Installing Python modules] ***************************************\r\nchanged: [192.168.90.41] => (item={u'dest': u'/usr/lib/python2.7/dist-packages/bzlib/__init__.py', u'src': u'usr/lib/python2.7/dist-packages/bzlib/__init__.py'})\r\nchanged: [192.168.90.41] => (item={u'dest': u'/usr/lib/python2.7/dist-packages/bzlib/files.py', u'src': u'usr/lib/python2.7/dist-packages/bzlib/files.py'})\r\nchanged: [192.168.90.41] => (item={u'dest': u'/usr/lib/python2.7/dist-packages/bzlib/geoloc.py', u'src': u'usr/lib/python2.7/dist-packages/bzlib/geoloc.py'})\r\nchanged: [192.168.90.41] => (item={u'dest': u'/usr/lib/python2.7/dist-packages/bzlib/sendto.py', u'src': u'usr/lib/python2.7/dist-packages/bzlib/sendto.py'})\r\n\r\nTASK [tools : Installing auth_info] ********************************************\r\nchanged: [192.168.90.41]\r\n\r\nTASK [tools : Setting permissions on auth_info] ********************************\r\nchanged: [192.168.90.41]\r\n\r\nTASK [tools : Installing bifrozt_config] ***************************************\r\nchanged: [192.168.90.41]\r\n\r\nTASK [tools : Setting permissions on bifrozt_config] ***************************\r\nchanged: [192.168.90.41]\r\n\r\nTASK [tools : Preparing to download GeoLite2-City database from Maxmind] *******\r\nchanged: [192.168.90.41]\r\n\r\nTASK [tools : Removing default honsshctrl.sh] **********************************\r\nok: [192.168.90.41]\r\n\r\nTASK [tools : Installing custom honsshctrl] ************************************\r\nchanged: [192.168.90.41]\r\n\r\nTASK [tools : Setting permissions on /usr/local/bin/honsshctrl] ****************\r\nchanged: [192.168.90.41]\r\n\r\nTASK [tools : Installing latests version of GeoLite2-City database from Maxmind] ***\r\nchanged: [192.168.90.41]\r\n\r\nTASK [tools : Unpacking GeoLite2-City database from Maxmind] *******************\r\nchanged: [192.168.90.41]\r\n\r\nTASK [cleanup : Removing all SSH keys and files that were used by Ansible] *****\r\nchanged: [192.168.90.41] => (item=/etc/ansible/BZKEY/id_rsa)\r\nchanged: [192.168.90.41] => (item=/etc/ansible/BZKEY/id_rsa.pub)\r\nchanged: [192.168.90.41] => (item=/root/.ssh/authorized_keys)\r\nok: [192.168.90.41] => (item=/root/.ssh/id_rsa)\r\nok: [192.168.90.41] => (item=/root/.ssh/id_rsa.pub)\r\nchanged: [192.168.90.41] => (item=/root/.ssh/known_hosts)\r\n\r\nTASK [cleanup : Starting purge of Ansible software] ****************************\r\nchanged: [192.168.90.41]\r\n\r\nPLAY RECAP *********************************************************************\r\n192.168.90.41                : ok=44   changed=32   unreachable=0    failed=0   \r\n\r\n2016-03-09 18:21:36 - Assigning a randomized IPv4 address to the honeypot...\r\n2016-03-09 18:21:36 - Updating the MAC address of the honeypot...\r\n2016-03-09 18:21:36 - Generating new DHCP network...\r\n2016-03-09 18:21:36 - DHCP will be using this network: 10.120.197.0/24\r\n2016-03-09 18:21:36 - The honeypot will be assigned this IPv4 address: 10.120.197.106\r\n2016-03-09 18:21:36 - Updating configuration on interface eth1...\r\n2016-03-09 18:21:36 - Updating honssh.cfg.default...\r\n2016-03-09 18:21:36 - Making active configuration file, honssh.cfg, from honssh.cfg.default...\r\n2016-03-09 18:21:36 - Restarting the eth1 interface...\r\n2016-03-09 18:21:36 - IPv4 address has been assigned to the eth1 interface: 10.120.197.1\r\n2016-03-09 18:21:36 - Restarting DHCP server...\r\n2016-03-09 18:21:36 - Selecting a new SSH port for Bifrozt administration...\r\n2016-03-09 18:21:36 - Updating sshd_config...\r\n2016-03-09 18:21:36 - Updating firewall rules...\r\n2016-03-09 18:21:36 - Restarting SSH server...\r\n2016-03-09 18:21:36 - The SSH server is now running on TCP port: 53725\r\n2016-03-09 18:21:36 - Applying new firewall rules...\r\n2016-03-09 18:21:36 - The firewall is now accepting SSH connections on TCP port: 53725\r\n2016-03-09 18:21:36 - bifrozt_setup.sh has completed its execution. Do the following:\r\n2016-03-09 18:21:36 - Note what port SSH is running on.\r\n2016-03-09 18:21:36 - If the honeypot is running, shut it off.\r\n2016-03-09 18:21:36 - Reboot Bifrozt (this machine).\r\n2016-03-09 18:21:36 - Start the honeypot machine once Bifrozt is rebooted.\r\n2016-03-09 18:21:36 - Start HonSSH with: sudo honsshctrl start.\r\n```\r\n\r\n---","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}